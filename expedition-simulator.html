<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur d'Exp√©ditions - Crownicles</title>
    <meta name="description" content="Simulateur d'exp√©ditions de familiers pour Crownicles - Calculez les r√©compenses et taux de succ√®s">
    <style>
        : root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --accent: #e94560;
            --text-primary: #ffffff;
            --text-secondary:  #a0a0a0;
            --success: #4ade80;
            --warning:  #fbbf24;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        * {
            margin: 0;
            padding:  0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:  linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color:  var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--accent);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-size: 2.5rem;
        }

        h2 {
            color: var(--accent);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 5px;
        }

        h3 {
            color: var(--info);
            margin:  20px 0 10px 0;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display:  block;
            margin-bottom:  5px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid var(--bg-tertiary);
            background:  var(--bg-primary);
            color: var(--text-primary);
            font-size:  14px;
            transition: border-color 0.3s;
        }

        select:focus, input: focus {
            outline: none;
            border-color: var(--accent);
        }

        .grid-2 {
            display: grid;
            grid-template-columns:  repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .grid-3 {
            display:  grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        button {
            background: var(--accent);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: block;
            width: 100%;
            margin-top:  20px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.4);
        }

        button:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        th {
            background:  var(--bg-tertiary);
            color: var(--accent);
            font-weight: 600;
        }

        tr:hover {
            background:  rgba(233, 69, 96, 0.1);
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .success-rate { color: var(--success); }
        .partial-rate { color: var(--warning); }
        .failure-rate { color: var(--danger); }

        .info-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius:  20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success { background: var(--success); color: #000; }
        .badge-warning { background: var(--warning); color: #000; }
        .badge-danger { background: var(--danger); color: #fff; }
        .badge-info { background: var(--info); color: #fff; }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            padding: 15px;
            border-radius: 8px;
            color: var(--danger);
        }

        .slider-container {
            position: relative;
            padding-top: 5px;
        }

        . slider-value {
            position: absolute;
            right: 0;
            top: -5px;
            background: var(--accent);
            padding: 2px 8px;
            border-radius:  4px;
            font-size: 12px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-tertiary);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance:  none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius:  50%;
            background: var(--accent);
            cursor:  pointer;
            border: none;
        }

        . checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .pet-info {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .pet-stat {
            background: var(--bg-tertiary);
            padding: 5px 10px;
            border-radius: 5px;
            font-size:  12px;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height:  25px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        . progress-bar-inner {
            height: 100%;
            display: flex;
        }

        .progress-success { background: var(--success); }
        .progress-partial { background: var(--warning); }
        .progress-failure { background: var(--danger); }

        .searchable-select-container {
            position: relative;
        }

        .pet-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y:  auto;
            background: var(--bg-primary);
            border: 2px solid var(--bg-tertiary);
            border-top: none;
            border-radius: 0 0 8px 8px;
            z-index: 1000;
            display: none;
        }

        .pet-dropdown.show {
            display: block;
        }

        .pet-option {
            padding: 10px 15px;
            cursor:  pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .pet-option:hover, .pet-option.selected {
            background: var(--bg-tertiary);
        }

        .pet-option-name {
            font-weight: 500;
        }

        .pet-option-stats {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        . toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform:  translateX(-50%) translateY(100px);
            background: var(--success);
            color: #000;
            padding: 15px 30px;
            border-radius:  10px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        . location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        . location-option {
            padding: 10px;
            border:  2px solid var(--bg-tertiary);
            border-radius: 8px;
            background: var(--bg-primary);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .location-option:hover {
            border-color: var(--accent);
        }

        .location-option. selected {
            border-color:  var(--accent);
            background: rgba(233, 69, 96, 0.2);
        }

        .location-option . icon {
            font-size: 24px;
            display: block;
            margin-bottom: 5px;
        }

        .location-option .name {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .duration-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .duration-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .duration-input-group input {
            width: 70px;
            text-align: center;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding:  20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            . grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            . location-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêæ Simulateur d'Exp√©ditions de Familier</h1>

        <!-- Toast notification -->
        <div id="toast" class="toast">‚úÖ R√©sultats calcul√©s !</div>

        <!-- Section:  Source des donn√©es -->
        <div class="card">
            <h2>üì¶ Source des donn√©es</h2>
            <div class="form-group">
                <label for="branchSelect">Branche GitHub</label>
                <select id="branchSelect">
                    <option value="main">main</option>
                    <option value="petexploration" selected>petexploration</option>
                    <option value="develop">develop</option>
                </select>
            </div>
            <button id="loadDataBtn">Charger les donn√©es des familiers</button>
            <div id="loadingStatus" class="loading hidden">Chargement des donn√©es</div>
            <div id="errorStatus" class="error hidden"></div>
        </div>

        <!-- Section: Configuration de l'exp√©dition -->
        <div class="card" id="configSection">
            <h2>‚öôÔ∏è Configuration de l'exp√©dition</h2>
            
            <div class="grid-2">
                <!-- S√©lection du familier avec recherche -->
                <div class="form-group">
                    <label>Familier √† envoyer</label>
                    <div class="searchable-select-container">
                        <input type="text" id="petSearchInput" class="pet-search-input" placeholder="Chargez d'abord les donn√©es..." disabled>
                        <div id="petDropdown" class="pet-dropdown"></div>
                        <input type="hidden" id="selectedPetId" value="">
                    </div>
                    <div id="petInfo" class="pet-info hidden">
                        <span class="pet-stat">Force: <strong id="petForce">-</strong></span>
                        <span class="pet-stat">Vitesse: <strong id="petSpeed">-</strong></span>
                        <span class="pet-stat">Raret√©: <strong id="petRarity">-</strong></span>
                    </div>
                </div>

                <!-- Points d'amour du familier -->
                <div class="form-group">
                    <label for="lovePoints">Points d'amour du familier (0-110)</label>
                    <div class="slider-container">
                        <span class="slider-value" id="lovePointsValue">100</span>
                        <input type="range" id="lovePoints" min="0" max="110" value="100">
                    </div>
                </div>
            </div>

            <!-- Type d'exp√©dition (lieu) -->
            <div class="form-group">
                <label>Type d'exp√©dition (lieu)</label>
                <div class="location-grid" id="locationGrid">
                    <div class="location-option selected" data-location="plains">
                        <span class="icon">üåæ</span>
                        <span class="name">Plaines</span>
                    </div>
                    <div class="location-option" data-location="forest">
                        <span class="icon">üå≤</span>
                        <span class="name">For√™t</span>
                    </div>
                    <div class="location-option" data-location="mountain">
                        <span class="icon">‚õ∞Ô∏è</span>
                        <span class="name">Montagne</span>
                    </div>
                    <div class="location-option" data-location="desert">
                        <span class="icon">üèúÔ∏è</span>
                        <span class="name">D√©sert</span>
                    </div>
                    <div class="location-option" data-location="swamp">
                        <span class="icon">üê∏</span>
                        <span class="name">Marais</span>
                    </div>
                    <div class="location-option" data-location="coast">
                        <span class="icon">üèñÔ∏è</span>
                        <span class="name">C√¥te</span>
                    </div>
                    <div class="location-option" data-location="ruins">
                        <span class="icon">üèõÔ∏è</span>
                        <span class="name">Ruines</span>
                    </div>
                    <div class="location-option" data-location="cave">
                        <span class="icon">üï≥Ô∏è</span>
                        <span class="name">Caverne</span>
                    </div>
                </div>
                <small id="locationInfo" style="color: var(--text-secondary); margin-top: 10px; display: block;">
                    Bonus:  Argent √ó1. 0, XP √ó1.0, Points √ó1.0
                </small>
            </div>

            <div class="grid-3">
                <!-- Richesse -->
                <div class="form-group">
                    <label for="wealthRate">Richesse (0. 0 - 2.0)</label>
                    <div class="slider-container">
                        <span class="slider-value" id="wealthRateValue">1.0</span>
                        <input type="range" id="wealthRate" min="0" max="200" value="100" step="1">
                    </div>
                    <small id="wealthCategory" style="color: var(--text-secondary);">Cat√©gorie:  Modestes</small>
                </div>

                <!-- Dangerosit√© -->
                <div class="form-group">
                    <label for="riskRate">Dangerosit√© (0 - 100)</label>
                    <div class="slider-container">
                        <span class="slider-value" id="riskRateValue">30</span>
                        <input type="range" id="riskRate" min="0" max="100" value="30">
                    </div>
                    <small id="riskCategory" style="color: var(--text-secondary);">Cat√©gorie: Peu risqu√©</small>
                </div>

                <!-- Difficult√© du terrain -->
                <div class="form-group">
                    <label for="difficulty">Difficult√© du terrain (0 - 100)</label>
                    <div class="slider-container">
                        <span class="slider-value" id="difficultyValue">30</span>
                        <input type="range" id="difficulty" min="0" max="100" value="30">
                    </div>
                    <small id="difficultyCategory" style="color: var(--text-secondary);">Cat√©gorie: Accessible</small>
                </div>
            </div>

            <div class="grid-2">
                <!-- Dur√©e de l'exp√©dition -->
                <div class="form-group">
                    <label>Dur√©e de l'exp√©dition</label>
                    <div class="duration-inputs">
                        <div class="duration-input-group">
                            <input type="number" id="durationDays" min="0" max="3" value="0">
                            <span>jours</span>
                        </div>
                        <div class="duration-input-group">
                            <input type="number" id="durationHours" min="0" max="23" value="1">
                            <span>heures</span>
                        </div>
                        <div class="duration-input-group">
                            <input type="number" id="durationMinutes" min="0" max="59" value="0">
                            <span>min</span>
                        </div>
                    </div>
                    <small id="durationDisplay" style="color: var(--text-secondary); margin-top: 5px; display: block;">= 60 minutes au total</small>
                </div>

                <!-- Options -->
                <div class="form-group">
                    <label>Options</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="hasCloneTalisman">
                        <label for="hasCloneTalisman" style="margin-bottom: 0; cursor: pointer;">
                            Poss√®de d√©j√† le Talisman de Clonage
                        </label>
                    </div>
                    <div class="checkbox-group" style="margin-top: 10px;">
                        <input type="checkbox" id="hasCloneTalismanBonus">
                        <label for="hasCloneTalismanBonus" style="margin-bottom: 0; cursor: pointer;">
                            Exp√©dition avec bonus Talisman de Clonage
                        </label>
                    </div>
                    <div class="checkbox-group" style="margin-top: 10px;">
                        <input type="checkbox" id="hasFood" checked>
                        <label for="hasFood" style="margin-bottom: 0; cursor: pointer;">
                            A assez de provisions
                        </label>
                    </div>
                </div>
            </div>

            <button id="calculateBtn">üé≤ Calculer les r√©sultats</button>
        </div>

        <!-- Section:  R√©sultats -->
        <div class="card results-section hidden" id="resultsSection">
            <h2>üìä R√©sultats de l'estimation</h2>

            <!-- Tableau r√©capitulatif de l'exp√©dition -->
            <h3>üìã R√©capitulatif de l'exp√©dition</h3>
            <table id="summaryTable">
                <thead>
                    <tr>
                        <th>Param√®tre</th>
                        <th>Valeur</th>
                        <th>Cat√©gorie</th>
                    </tr>
                </thead>
                <tbody id="summaryBody">
                    <tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">Cliquez sur "Calculer les r√©sultats"</td></tr>
                </tbody>
            </table>

            <!-- Barre de progression des taux -->
            <h3>üéØ Taux de succ√®s</h3>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="successBar">
                    <div class="progress-success" style="width: 0%"></div>
                    <div class="progress-partial" style="width: 0%"></div>
                    <div class="progress-failure" style="width: 0%"></div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px;">
                <span class="success-rate">üü¢ Succ√®s total: <span id="totalSuccessRate">-</span></span>
                <span class="partial-rate">üü° Succ√®s partiel: <span id="partialSuccessRate">-</span></span>
                <span class="failure-rate">üî¥ √âchec:  <span id="failureRate">-</span></span>
            </div>

            <!-- Tableau des r√©compenses estim√©es -->
            <h3>üí∞ R√©compenses estim√©es</h3>
            <table id="rewardsTable">
                <thead>
                    <tr>
                        <th>R√©compense</th>
                        <th>Succ√®s total</th>
                        <th>Succ√®s partiel</th>
                    </tr>
                </thead>
                <tbody id="rewardsBody">
                    <tr><td colspan="3" style="text-align: center; color:  var(--text-secondary);">Cliquez sur "Calculer les r√©sultats"</td></tr>
                </tbody>
            </table>

            <!-- Tableau des chances d'items -->
            <h3>üéÅ Chances d'items et talisman</h3>
            <table id="itemsTable">
                <thead>
                    <tr>
                        <th>√âl√©ment</th>
                        <th>Chance / Valeur</th>
                    </tr>
                </thead>
                <tbody id="itemsBody">
                    <tr><td colspan="2" style="text-align: center; color: var(--text-secondary);">Cliquez sur "Calculer les r√©sultats"</td></tr>
                </tbody>
            </table>

            <!-- Tableau des effets sur l'amour -->
            <h3>üíï Effets sur les points d'amour</h3>
            <table id="loveTable">
                <thead>
                    <tr>
                        <th>R√©sultat</th>
                        <th>Changement d'amour</th>
                        <th>Probabilit√©</th>
                    </tr>
                </thead>
                <tbody id="loveBody">
                    <tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">Cliquez sur "Calculer les r√©sultats"</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Simulateur d'exp√©ditions pour <a href="https://github.com/Crownicles/Crownicles" target="_blank">Crownicles</a></p>
            <p>Version autonome - H√©bergeable facilement | Mis √† jour le 2025-12-26</p>
        </div>
    </div>

    <script>
        // ========================================
        // CONSTANTS (from Crownicles codebase)
        // ========================================
        const ExpeditionConstants = {
            DURATION:  {
                MIN_MINUTES: 10,
                MAX_MINUTES:  3 * 24 * 60 // 3 days = 4320 minutes
            },
            RISK_RATE: { MIN: 0, MAX: 100 },
            DIFFICULTY: { MIN: 0, MAX: 100 },
            WEALTH_RATE: { MIN: 0.0, MAX: 2.0 },
            RISK_DISPLAY_CATEGORIES: {
                VERY_LOW: { MAX: 15, NAME: "veryLow" },
                LOW: { MAX: 30, NAME: "low" },
                MEDIUM: { MAX: 50, NAME: "medium" },
                HIGH: { MAX: 70, NAME: "high" },
                VERY_HIGH: { MAX: 100, NAME: "veryHigh" }
            },
            DIFFICULTY_DISPLAY_CATEGORIES:  {
                TRIVIAL: { MAX: 20, NAME: "trivial" },
                EASY: { MAX: 40, NAME: "easy" },
                MODERATE: { MAX: 60, NAME: "moderate" },
                CHALLENGING: { MAX: 80, NAME: "challenging" },
                TREACHEROUS: { MAX: 100, NAME: "treacherous" }
            },
            REWARD_DISPLAY_CATEGORIES: {
                MEAGER: { MAX: 1, NAME: "meager" },
                MODEST: { MAX:  3, NAME: "modest" },
                SUBSTANTIAL: { MAX: 5, NAME: "substantial" },
                BOUNTIFUL: { MAX: 7, NAME: "bountiful" },
                LEGENDARY: { MAX: 9, NAME: "legendary" }
            },
            REWARD_TABLES: {
                MONEY: [50, 120, 235, 435, 710, 1300, 2100, 3200, 4200, 5000],
                EXPERIENCE: [50, 150, 350, 600, 950, 1400, 1950, 2550, 3000, 3500],
                POINTS: [6, 20, 75, 145, 210, 340, 420, 585, 650, 710]
            },
            FOOD_CONSUMPTION: [1, 3, 5, 6, 8, 10, 12, 15, 25, 32],
            WEALTH_RATE_REWARD_INDEX_BONUS: 0.30,
            EFFECTIVE_RISK_FORMULA: {
                DIFFICULTY_DIVISOR: 3,
                LOVE_DIVISOR: 10
            },
            NO_FOOD_RISK_MULTIPLIER: 3,
            LOVE_CHANGES:  {
                TOTAL_FAILURE:  -10,
                TOTAL_SUCCESS:  5
            },
            CLONE_TALISMAN:  {
                BASE_DROP_CHANCE: 0.5,
                REWARD_INDEX_BONUS_PER_POINT: 0.5,
                BONUS_EXPEDITION_MULTIPLIER: 10
            },
            ITEM_REWARD:  {
                MIN_RARITY_OFFSET: 3,
                MIN_RARITY_FLOOR: 1,
                MAX_RARITY_BY_REWARD_INDEX: [5, 5, 6, 7, 8, 8, 8, 8, 8, 8]
            },
            SPEED_DURATION_MODIFIER: {
                MIN_SPEED: 0,
                MAX_SPEED: 30,
                BASE_MULTIPLIER: 1.20,
                REDUCTION_PER_SPEED_POINT: 0.01666
            },
            LOCATION_REWARD_WEIGHTS: {
                forest: { money: 0.8, experience: 1.3, points: 0.9 },
                mountain: { money: 1.9, experience: 1, points: 0.3 },
                desert: { money: 0.6, experience: 0.4, points: 1.5 },
                swamp: { money: 0.4, experience: 1, points: 1.6 },
                ruins: { money: 1.7, experience: 1, points: 0.5 },
                cave: { money: 2.2, experience: 0.5, points: 0.2 },
                plains: { money: 1, experience: 1, points: 1 },
                coast: { money: 1.2, experience: 0.7, points: 0.8 }
            }
        };

        // Translations
        const translations = {
            riskCategories: {
                veryLow: "Paisible",
                low: "Peu risqu√©",
                medium: "Mod√©r√©",
                high: "Dangereux",
                veryHigh:  "P√©rilleux"
            },
            difficultyCategories: {
                trivial: "Ais√©",
                easy: "Accessible",
                moderate: "Exigeant",
                challenging:  "Ardu",
                treacherous:  "Impitoyable"
            },
            rewardCategories: {
                meager: "Maigres",
                modest: "Modestes",
                substantial: "Correctes",
                bountiful:  "Abondantes",
                legendary: "Exceptionnelles"
            },
            wealthCategories: {
                meager: "Pauvres",
                modest: "Modestes",
                substantial:  "Riches",
                legendary: "L√©gendaires"
            },
            itemRarities: [
                "Basique", "Commun", "Peu commun", "Exotique",
                "Rare", "Sp√©cial", "√âpique", "L√©gendaire", "Mythique"
            ],
            petRarities: [
                "Aucun", "Commun", "Peu commun", "Rare",
                "Sp√©cial", "√âpique", "L√©gendaire"
            ],
            locationNames: {
                plains: "Plaines", forest: "For√™t", mountain: "Montagne",
                desert: "D√©sert", swamp: "Marais", coast: "C√¥te",
                ruins: "Ruines", cave: "Caverne"
            }
        };

        // ========================================
        // GLOBAL STATE
        // ========================================
        let petsData = {};
        let petNames = {};
        let petsArray = [];
        let selectedLocation = "plains";

        // ========================================
        // DOM ELEMENTS
        // ========================================
        const elements = {
            branchSelect: document.getElementById('branchSelect'),
            loadDataBtn: document.getElementById('loadDataBtn'),
            loadingStatus: document.getElementById('loadingStatus'),
            errorStatus: document.getElementById('errorStatus'),
            petSearchInput: document.getElementById('petSearchInput'),
            petDropdown: document.getElementById('petDropdown'),
            selectedPetIdInput: document.getElementById('selectedPetId'),
            calculateBtn: document.getElementById('calculateBtn'),
            locationGrid: document.getElementById('locationGrid'),
            locationInfo: document.getElementById('locationInfo'),
            resultsSection: document.getElementById('resultsSection'),
            toast: document.getElementById('toast')
        };

        // Sliders
        const sliders = {
            lovePoints: { 
                element: document.getElementById('lovePoints'), 
                display: document.getElementById('lovePointsValue') 
            },
            wealthRate: { 
                element: document.getElementById('wealthRate'), 
                display: document.getElementById('wealthRateValue'), 
                category: document.getElementById('wealthCategory') 
            },
            riskRate: { 
                element: document.getElementById('riskRate'), 
                display: document. getElementById('riskRateValue'), 
                category: document.getElementById('riskCategory') 
            },
            difficulty: { 
                element: document.getElementById('difficulty'), 
                display: document.getElementById('difficultyValue'), 
                category:  document.getElementById('difficultyCategory') 
            }
        };

        // Duration inputs
        const durationInputs = {
            days: document.getElementById('durationDays'),
            hours: document. getElementById('durationHours'),
            minutes: document.getElementById('durationMinutes'),
            display: document.getElementById('durationDisplay')
        };

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function getRiskCategoryName(riskRate) {
            const cats = ExpeditionConstants.RISK_DISPLAY_CATEGORIES;
            if (riskRate <= cats.VERY_LOW. MAX) return cats.VERY_LOW.NAME;
            if (riskRate <= cats.LOW. MAX) return cats.LOW.NAME;
            if (riskRate <= cats.MEDIUM.MAX) return cats.MEDIUM.NAME;
            if (riskRate <= cats.HIGH.MAX) return cats.HIGH.NAME;
            return cats.VERY_HIGH.NAME;
        }

        function getDifficultyCategoryName(difficulty) {
            const cats = ExpeditionConstants.DIFFICULTY_DISPLAY_CATEGORIES;
            if (difficulty <= cats.TRIVIAL. MAX) return cats.TRIVIAL.NAME;
            if (difficulty <= cats.EASY.MAX) return cats.EASY.NAME;
            if (difficulty <= cats. MODERATE.MAX) return cats.MODERATE.NAME;
            if (difficulty <= cats.CHALLENGING. MAX) return cats.CHALLENGING. NAME;
            return cats.TREACHEROUS.NAME;
        }

        function getRewardCategoryName(rewardIndex) {
            const cats = ExpeditionConstants.REWARD_DISPLAY_CATEGORIES;
            if (rewardIndex <= cats.MEAGER.MAX) return cats.MEAGER.NAME;
            if (rewardIndex <= cats.MODEST.MAX) return cats.MODEST.NAME;
            if (rewardIndex <= cats.SUBSTANTIAL.MAX) return cats.SUBSTANTIAL.NAME;
            if (rewardIndex <= cats. BOUNTIFUL.MAX) return cats.BOUNTIFUL.NAME;
            return cats.LEGENDARY.NAME;
        }

        function getWealthCategoryName(wealthRate) {
            if (wealthRate <= 0.5) return "meager";
            if (wealthRate <= 1.0) return "modest";
            if (wealthRate <= 1.5) return "substantial";
            return "legendary";
        }

        function formatDuration(minutes) {
            if (minutes < 60) return `${minutes} min`;
            if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return mins > 0 ? `${hours}h ${mins}min` : `${hours}h`;
            }
            const days = Math.floor(minutes / 1440);
            const hours = Math.floor((minutes % 1440) / 60);
            return hours > 0 ? `${days}j ${hours}h` : `${days}j`;
        }

        function calculateLinearScore(value, min, max) {
            const percentage = (value - min) / (max - min);
            return percentage * 3;
        }

        function calculateRewardIndex(duration, riskRate, difficulty, wealthRate) {
            const durationScore = calculateLinearScore(
                duration,
                ExpeditionConstants. DURATION.MIN_MINUTES,
                ExpeditionConstants.DURATION.MAX_MINUTES
            );
            const riskScore = calculateLinearScore(
                riskRate,
                ExpeditionConstants.RISK_RATE.MIN,
                ExpeditionConstants. RISK_RATE.MAX
            );
            const difficultyScore = calculateLinearScore(
                difficulty,
                ExpeditionConstants.DIFFICULTY.MIN,
                ExpeditionConstants.DIFFICULTY.MAX
            );

            const baseIndex = (durationScore * 3) + riskScore + difficultyScore;
            const wealthRateMultiplier = 1 + (wealthRate - 1) * ExpeditionConstants.WEALTH_RATE_REWARD_INDEX_BONUS;
            const adjustedIndex = baseIndex * wealthRateMultiplier;

            return Math.max(0, Math.min(9, Math.round(adjustedIndex)));
        }

        function calculateEffectiveRisk(riskRate, difficulty, petForce, lovePoints, hasFood) {
            let effectiveRisk = riskRate
                + difficulty / ExpeditionConstants.EFFECTIVE_RISK_FORMULA. DIFFICULTY_DIVISOR
                - petForce
                - lovePoints / ExpeditionConstants.EFFECTIVE_RISK_FORMULA.LOVE_DIVISOR;

            if (! hasFood) {
                effectiveRisk *= ExpeditionConstants. NO_FOOD_RISK_MULTIPLIER;
            }

            return Math.max(0, Math.min(100, effectiveRisk));
        }

        function calculateCloneTalismanChance(rewardIndex, hasCloneTalisman, hasBonus) {
            if (hasCloneTalisman) return 0;

            let dropChance = ExpeditionConstants.CLONE_TALISMAN.BASE_DROP_CHANCE
                + rewardIndex * ExpeditionConstants.CLONE_TALISMAN.REWARD_INDEX_BONUS_PER_POINT;

            if (hasBonus) {
                dropChance *= ExpeditionConstants.CLONE_TALISMAN.BONUS_EXPEDITION_MULTIPLIER;
            }

            return dropChance;
        }

        function calculateItemRarityRange(rewardIndex) {
            const minRarity = Math.max(
                ExpeditionConstants.ITEM_REWARD.MIN_RARITY_FLOOR,
                rewardIndex - ExpeditionConstants.ITEM_REWARD.MIN_RARITY_OFFSET
            );
            const maxRarity = ExpeditionConstants.ITEM_REWARD.MAX_RARITY_BY_REWARD_INDEX[rewardIndex];
            return { minRarity, maxRarity };
        }

        function calculateBaseRewards(rewardIndex, locationType) {
            const locationWeights = ExpeditionConstants. LOCATION_REWARD_WEIGHTS[locationType] || 
                { money: 1, experience: 1, points: 1 };
            return {
                money: Math.round(ExpeditionConstants.REWARD_TABLES.MONEY[rewardIndex] * locationWeights.money),
                experience: Math.round(ExpeditionConstants.REWARD_TABLES.EXPERIENCE[rewardIndex] * locationWeights.experience),
                points: Math.round(ExpeditionConstants.REWARD_TABLES.POINTS[rewardIndex] * locationWeights. points)
            };
        }

        function calculateSpeedModifier(petSpeed) {
            return ExpeditionConstants.SPEED_DURATION_MODIFIER.BASE_MULTIPLIER 
                - petSpeed * ExpeditionConstants.SPEED_DURATION_MODIFIER.REDUCTION_PER_SPEED_POINT;
        }

        function showToast() {
            elements.toast.classList.add('show');
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 2000);
        }

        // ========================================
        // DATA LOADING
        // ========================================
        async function loadPetData() {
            const branch = elements.branchSelect.value;
            elements.loadingStatus.classList.remove('hidden');
            elements.errorStatus.classList.add('hidden');
            elements.loadDataBtn.disabled = true;

            try {
                const petsUrl = `https://raw.githubusercontent.com/Crownicles/Crownicles/${branch}/Core/resources/text/pets.json`;
                const namesUrl = `https://raw.githubusercontent.com/Crownicles/Crownicles/${branch}/Lang/fr/pets.json`;

                const [petsResponse, namesResponse] = await Promise.all([
                    fetch(petsUrl),
                    fetch(namesUrl)
                ]);

                if (!petsResponse.ok || ! namesResponse.ok) {
                    throw new Error('Erreur de chargement des donn√©es');
                }

                petsData = await petsResponse. json();
                petNames = await namesResponse.json();

                // Build searchable array
                petsArray = Object. entries(petsData).map(([id, data]) => ({
                    id:  parseInt(id),
                    name: petNames[id] || `Pet ${id}`,
                    force: data.baseStats?. force || 0,
                    speed: data.baseStats?.speed || 0,
                    rarity: data.rarity || 1
                })).sort((a, b) => a.name.localeCompare(b. name));

                elements.loadingStatus.classList.add('hidden');
                elements.petSearchInput.disabled = false;
                elements.petSearchInput.placeholder = "Rechercher un familier...";
                elements.calculateBtn.disabled = false;

                showToast();
                elements.toast.textContent = "‚úÖ Donn√©es charg√©es ! ";

            } catch (error) {
                elements.loadingStatus.classList.add('hidden');
                elements.errorStatus.classList.remove('hidden');
                elements.errorStatus.textContent = `Erreur: ${error.message}.  V√©rifiez la branche ou votre connexion.`;
                elements.loadDataBtn.disabled = false;
            }
        }

        // ========================================
        // PET SEARCH & SELECT
        // ========================================
        function filterPets(searchText) {
            const filtered = petsArray.filter(pet => 
                pet.name. toLowerCase().includes(searchText.toLowerCase())
            );
            renderPetDropdown(filtered);
        }

        function renderPetDropdown(pets) {
            if (pets.length === 0) {
                elements.petDropdown.innerHTML = '<div class="no-results">Aucun familier trouv√©</div>';
                elements.petDropdown.classList.add('show');
                return;
            }

            elements.petDropdown. innerHTML = pets.map(pet => `
                <div class="pet-option" data-pet-id="${pet.id}">
                    <div class="pet-option-name">${pet.name}</div>
                    <div class="pet-option-stats">
                        Force: ${pet.force} | Vitesse: ${pet. speed} | ${translations.petRarities[pet.rarity] || 'Commun'}
                    </div>
                </div>
            `).join('');

            elements. petDropdown.classList.add('show');

            // Add click handlers
            document.querySelectorAll('.pet-option').forEach(option => {
                option.addEventListener('click', () => {
                    const petId = parseInt(option.dataset.petId);
                    selectPet(petId);
                });
            });
        }

        function selectPet(petId) {
            const pet = petsArray.find(p => p.id === petId);
            if (! pet) return;

            elements.selectedPetIdInput.value = petId;
            elements. petSearchInput.value = pet.name;
            elements.petDropdown.classList.remove('show');

            // Show pet info
            document.getElementById('petForce').textContent = pet.force;
            document.getElementById('petSpeed').textContent = pet.speed;
            document.getElementById('petRarity').textContent = translations. petRarities[pet.rarity] || 'Commun';
            document.getElementById('petInfo').classList.remove('hidden');
        }

        // ========================================
        // SLIDER UPDATES
        // ========================================
        function updateSliderDisplays() {
            // Love points
            sliders.lovePoints.display.textContent = sliders.lovePoints.element.value;

            // Wealth rate
            const wealthValue = parseFloat(sliders.wealthRate.element.value) / 100;
            sliders.wealthRate.display.textContent = wealthValue.toFixed(1);
            const wealthCat = getWealthCategoryName(wealthValue);
            sliders.wealthRate.category.textContent = `Cat√©gorie:  ${translations.wealthCategories[wealthCat]}`;

            // Risk rate
            const riskValue = parseInt(sliders.riskRate. element.value);
            sliders.riskRate.display.textContent = riskValue;
            const riskCat = getRiskCategoryName(riskValue);
            sliders.riskRate.category.textContent = `Cat√©gorie: ${translations.riskCategories[riskCat]}`;

            // Difficulty
            const diffValue = parseInt(sliders.difficulty.element. value);
            sliders.difficulty.display.textContent = diffValue;
            const diffCat = getDifficultyCategoryName(diffValue);
            sliders. difficulty.category.textContent = `Cat√©gorie: ${translations. difficultyCategories[diffCat]}`;
        }

        function updateDurationDisplay() {
            const days = parseInt(durationInputs.days. value) || 0;
            const hours = parseInt(durationInputs. hours.value) || 0;
            const minutes = parseInt(durationInputs. minutes.value) || 0;

            const totalMinutes = days * 1440 + hours * 60 + minutes;
            durationInputs.display.textContent = `= ${totalMinutes} minutes au total (${formatDuration(totalMinutes)})`;
        }

        function updateLocationInfo() {
            const weights = ExpeditionConstants.LOCATION_REWARD_WEIGHTS[selectedLocation] || 
                { money: 1, experience: 1, points: 1 };
            elements.locationInfo.textContent = 
                `Bonus:  Argent √ó${weights.money. toFixed(1)}, XP √ó${weights.experience. toFixed(1)}, Points √ó${weights.points.toFixed(1)}`;
        }

        // ========================================
        // CALCULATION
        // ========================================
        function calculateResults() {
            const petId = parseInt(elements.selectedPetIdInput.value);
            if (!petId || ! petsData[petId]) {
                alert('Veuillez s√©lectionner un familier valide');
                return;
            }

            const pet = petsArray.find(p => p.id === petId);
            const lovePoints = parseInt(sliders. lovePoints.element.value);
            const wealthRate = parseFloat(sliders.wealthRate.element.value) / 100;
            const riskRate = parseInt(sliders.riskRate.element.value);
            const difficulty = parseInt(sliders.difficulty.element.value);
            const hasFood = document.getElementById('hasFood').checked;
            const hasCloneTalisman = document. getElementById('hasCloneTalisman').checked;
            const hasCloneTalismanBonus = document.getElementById('hasCloneTalismanBonus').checked;

            // Duration
            const days = parseInt(durationInputs. days.value) || 0;
            const hours = parseInt(durationInputs.hours.value) || 0;
            const minutes = parseInt(durationInputs. minutes.value) || 0;
            const totalMinutes = days * 1440 + hours * 60 + minutes;

            if (totalMinutes < ExpeditionConstants.DURATION.MIN_MINUTES) {
                alert(`La dur√©e minimale est de ${ExpeditionConstants.DURATION.MIN_MINUTES} minutes`);
                return;
            }

            if (totalMinutes > ExpeditionConstants.DURATION.MAX_MINUTES) {
                alert(`La dur√©e maximale est de ${ExpeditionConstants.DURATION.MAX_MINUTES} minutes (3 jours)`);
                return;
            }

            // Calculate reward index
            const rewardIndex = calculateRewardIndex(totalMinutes, riskRate, difficulty, wealthRate);

            // Calculate effective risk
            const effectiveRisk = calculateEffectiveRisk(riskRate, difficulty, pet.force, lovePoints, hasFood);

            // Success rates
            const totalSuccessRate = Math.max(0, Math.min(100, 100 - effectiveRisk));
            const partialSuccessRate = Math.max(0, Math.min(100, effectiveRisk * 0.5));
            const failureRate = Math.max(0, 100 - totalSuccessRate - partialSuccessRate);

            // Rewards
            const baseRewards = calculateBaseRewards(rewardIndex, selectedLocation);
            const partialRewards = {
                money: Math.round(baseRewards.money * 0.5),
                experience: Math.round(baseRewards.experience * 0.5),
                points: Math.round(baseRewards. points * 0.5)
            };

            // Food consumption
            const foodConsumption = ExpeditionConstants.FOOD_CONSUMPTION[rewardIndex];

            // Items
            const itemRarity = calculateItemRarityRange(rewardIndex);

            // Clone talisman
            const cloneTalismanChance = calculateCloneTalismanChance(rewardIndex, hasCloneTalisman, hasCloneTalismanBonus);

            // Love changes
            const loveSuccess = ExpeditionConstants.LOVE_CHANGES. TOTAL_SUCCESS;
            const lovePartial = 0;
            const loveFailure = ExpeditionConstants.LOVE_CHANGES.TOTAL_FAILURE;

            // Render results
            renderResults({
                pet,
                rewardIndex,
                totalMinutes,
                riskRate,
                difficulty,
                wealthRate,
                effectiveRisk,
                totalSuccessRate,
                partialSuccessRate,
                failureRate,
                baseRewards,
                partialRewards,
                foodConsumption,
                itemRarity,
                cloneTalismanChance,
                loveSuccess,
                lovePartial,
                loveFailure
            });

            // Show results section
            elements.resultsSection.classList.remove('hidden');
            elements.resultsSection.scrollIntoView({ behavior: 'smooth' });
            showToast();
        }

        function renderResults(data) {
            // Summary table
            const summaryBody = document.getElementById('summaryBody');
            summaryBody.innerHTML = `
                <tr>
                    <td>Familier</td>
                    <td>${data.pet. name}</td>
                    <td>Force:  ${data.pet.force}, Vitesse: ${data.pet.speed}</td>
                </tr>
                <tr>
                    <td>Dur√©e</td>
                    <td>${formatDuration(data. totalMinutes)}</td>
                    <td>${data.totalMinutes} minutes</td>
                </tr>
                <tr>
                    <td>Richesse</td>
                    <td>${data.wealthRate.toFixed(1)}</td>
                    <td>${translations.wealthCategories[getWealthCategoryName(data. wealthRate)]}</td>
                </tr>
                <tr>
                    <td>Dangerosit√©</td>
                    <td>${data.riskRate}%</td>
                    <td>${translations.riskCategories[getRiskCategoryName(data.riskRate)]}</td>
                </tr>
                <tr>
                    <td>Difficult√©</td>
                    <td>${data.difficulty}%</td>
                    <td>${translations.difficultyCategories[getDifficultyCategoryName(data.difficulty)]}</td>
                </tr>
                <tr>
                    <td>Indice de r√©compense</td>
                    <td><strong>${data.rewardIndex}</strong></td>
                    <td>${translations.rewardCategories[getRewardCategoryName(data. rewardIndex)]}</td>
                </tr>
                <tr>
                    <td>Risque effectif</td>
                    <td><strong>${data. effectiveRisk. toFixed(1)}%</strong></td>
                    <td>${data.effectiveRisk < 30 ? 'üü¢ Faible' : data.effectiveRisk < 60 ? 'üü° Moyen' : 'üî¥ √âlev√©'}</td>
                </tr>
            `;

            // Success bar
            const successBar = document. getElementById('successBar');
            successBar.innerHTML = `
                <div class="progress-success" style="width: ${data.totalSuccessRate}%"></div>
                <div class="progress-partial" style="width:  ${data.partialSuccessRate}%"></div>
                <div class="progress-failure" style="width: ${data.failureRate}%"></div>
            `;

            document.getElementById('totalSuccessRate').textContent = `${data.totalSuccessRate. toFixed(1)}%`;
            document.getElementById('partialSuccessRate').textContent = `${data.partialSuccessRate. toFixed(1)}%`;
            document.getElementById('failureRate').textContent = `${data.failureRate.toFixed(1)}%`;

            // Rewards table
            const rewardsBody = document.getElementById('rewardsBody');
            rewardsBody. innerHTML = `
                <tr>
                    <td>üí∞ Argent</td>
                    <td><strong>${data.baseRewards.money}</strong></td>
                    <td>${data.partialRewards.money}</td>
                </tr>
                <tr>
                    <td>‚≠ê Exp√©rience</td>
                    <td><strong>${data.baseRewards.experience}</strong></td>
                    <td>${data.partialRewards.experience}</td>
                </tr>
                <tr>
                    <td>üèÜ Points</td>
                    <td><strong>${data. baseRewards.points}</strong></td>
                    <td>${data.partialRewards.points}</td>
                </tr>
                <tr>
                    <td>üçñ Nourriture consomm√©e</td>
                    <td colspan="2"><strong>${data.foodConsumption}</strong></td>
                </tr>
            `;

            // Items table
            const itemsBody = document.getElementById('itemsBody');
            itemsBody.innerHTML = `
                <tr>
                    <td>üéÅ Raret√© d'item minimum</td>
                    <td><strong>${translations.itemRarities[data.itemRarity. minRarity]}</strong> (${data.itemRarity. minRarity})</td>
                </tr>
                <tr>
                    <td>üéÅ Raret√© d'item maximum</td>
                    <td><strong>${translations. itemRarities[data.itemRarity.maxRarity]}</strong> (${data.itemRarity.maxRarity})</td>
                </tr>
                <tr>
                    <td>üîÆ Chance Talisman de Clonage</td>
                    <td><strong>${data.cloneTalismanChance.toFixed(2)}%</strong></td>
                </tr>
            `;

            // Love table
            const loveBody = document.getElementById('loveBody');
            loveBody.innerHTML = `
                <tr>
                    <td>üü¢ Succ√®s total</td>
                    <td><strong>+${data.loveSuccess}</strong></td>
                    <td>${data.totalSuccessRate.toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>üü° Succ√®s partiel</td>
                    <td><strong>${data.lovePartial}</strong></td>
                    <td>${data.partialSuccessRate.toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>üî¥ √âchec total</td>
                    <td><strong>${data.loveFailure}</strong></td>
                    <td>${data.failureRate.toFixed(1)}%</td>
                </tr>
            `;
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        elements.loadDataBtn.addEventListener('click', loadPetData);
        elements.calculateBtn.addEventListener('click', calculateResults);

        // Pet search
        elements.petSearchInput. addEventListener('input', (e) => {
            const searchText = e.target.value.trim();
            if (searchText. length > 0) {
                filterPets(searchText);
            } else {
                elements.petDropdown.classList.remove('show');
            }
        });

        elements.petSearchInput.addEventListener('focus', () => {
            if (petsArray.length > 0 && elements.petSearchInput.value.trim()) {
                filterPets(elements.petSearchInput.value.trim());
            }
        });

        // Close dropdown when clicking outside
        document. addEventListener('click', (e) => {
            if (!elements.petSearchInput.contains(e.target) && !elements.petDropdown. contains(e.target)) {
                elements.petDropdown.classList.remove('show');
            }
        });

        // Sliders
        Object.values(sliders).forEach(slider => {
            slider.element.addEventListener('input', updateSliderDisplays);
        });

        // Duration inputs
        Object.values(durationInputs).forEach(input => {
            if (input.addEventListener) {
                input.addEventListener('input', updateDurationDisplay);
            }
        });

        // Location selection
        document.querySelectorAll('.location-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.location-option').forEach(opt => 
                    opt.classList.remove('selected')
                );
                option.classList.add('selected');
                selectedLocation = option.dataset.location;
                updateLocationInfo();
            });
        });

        // Initialize displays
        updateSliderDisplays();
        updateDurationDisplay();
        updateLocationInfo();

        // Initial state
        elements.calculateBtn.disabled = true;
    </script>
</body>
</html>